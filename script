-- WEBHOOK V1.1 (FIXED PUBLIC SAFE)

-- SERVICES
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local Players = game:GetService("Players")

-- HTTP REQUEST (FIXED)
local http_request =
    (syn and syn.request)
    or (http and http.request)
    or request

-- CONFIG SAVE
local FileName = "ZavideConfig.json"
local SaveLock = false

local function SaveConfig()
    if SaveLock then return end
    SaveLock = true
    task.wait(0.5)
    pcall(function()
        local Config = {
            WebhookURL = getgenv().WebhookURL or "",
            Toggles = getgenv().Toggles or {},
            Active = getgenv().SeiLogger_Active or false
        }
        writefile(FileName, HttpService:JSONEncode(Config))
    end)
    SaveLock = false
end

local function LoadConfig()
    getgenv().WebhookURL = ""
    getgenv().Toggles = {Epic=false, Legendary=false, Mythical=false, Secret=false}
    getgenv().SeiLogger_Active = false

    if isfile(FileName) then
        local ok, content = pcall(readfile, FileName)
        if ok and content then
            local success, data = pcall(HttpService.JSONDecode, HttpService, content)
            if success and data then
                getgenv().WebhookURL = data.WebhookURL or ""
                getgenv().Toggles = data.Toggles or getgenv().Toggles
                getgenv().SeiLogger_Active = data.Active or false
            end
        end
    end
end
LoadConfig()

-- ANTI AFK
for _,v in pairs(getconnections(Players.LocalPlayer.Idled)) do
    v:Disable()
end
Players.LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- UI
local Window = Fluent:CreateWindow({
    Title = "Zavide Logger",
    SubTitle = "Premium Edition | Public Fix",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark"
})

-- TOGGLE BUTTON
local function CreateToggleButton()
    local p = game:GetService("CoreGui")
    local sg = Instance.new("ScreenGui", p)
    sg.Name = "SeiToggleGui"
    sg.ResetOnSpawn = false

    local btn = Instance.new("ImageButton", sg)
    btn.Size = UDim2.new(0,45,0,45)
    btn.Position = UDim2.new(0,15,0.5,-22)
    btn.BackgroundTransparency = 0.2
    btn.Image = "rbxassetid://134196935407184"
    btn.Draggable = true

    Instance.new("UICorner", btn)
    btn.MouseButton1Click:Connect(function()
        Window:Minimize()
    end)
end
CreateToggleButton()

-- PARSER
local function parseFishData(rawText)
    local clean = rawText:gsub("<[^>]*>", ""):gsub("%s+", " ")
    local player = clean:match("%[Server%]:%s*(.-)%s+obtained") or "Unknown"
    local fish = clean:match("obtained%s+an?%s+(.-)%s?%(") or "Unknown"
    local weight = clean:match("%((.-)%)") or "N/A"

    local r,g,b = rawText:match("rgb%((%d+),%s*(%d+),%s*(%d+)%)")
    local rarity = "Unknown"

    if r then
        r,g,b = tonumber(r),tonumber(g),tonumber(b)
        if r==179 and g==115 then rarity="Epic"
        elseif r==255 and g==185 then rarity="Legendary"
        elseif r>180 and g<100 then rarity="Mythical"
        elseif g>200 then rarity="Secret" end
    end

    return {Player=player, Name=fish, Weight=weight, Rarity=rarity}
end

-- WEBHOOK SENDER (FIXED)
local function SendWebhook(payload)
    if not http_request or getgenv().WebhookURL == "" then return false end

    local success, res = pcall(function()
        return http_request({
            Url = getgenv().WebhookURL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end)

    if not success or not res then return false end
    if res.StatusCode ~= 200 and res.StatusCode ~= 204 then return false end
    return true
end

-- MAIN EVENT
local Remote = game:GetService("ReplicatedStorage")
    .Packages._Index["sleitnick_net@0.2.0"].net["RE/DisplaySystemMessage"]

Remote.OnClientEvent:Connect(function(rawText)
    if not getgenv().SeiLogger_Active or getgenv().WebhookURL == "" then return end
    if not string.find(rawText,"obtained") then return end

    local data = parseFishData(rawText)
    if not getgenv().Toggles[data.Rarity] then return end

    local colors = {
        Epic = 10040319,
        Legendary = 16766720,
        Mythical = 16711680,
        Secret = 65535
    }

    SendWebhook({
        content = data.Rarity=="Secret" and "@everyone" or nil,
        embeds = {{
            title = "ðŸŽ£ Zavide Logger",
            color = colors[data.Rarity],
            fields = {
                {name="Player", value="```"..data.Player.."```"},
                {name="Fish", value="```"..data.Name.."```"},
                {name="Tier", value="```"..data.Rarity.."```", inline=true},
                {name="Weight", value="```"..data.Weight.."```", inline=true}
            }
        }}
    })
end)

-- UI TABS
local Tabs = {
    Main = Window:AddTab({Title="Settings"}),
    Filters = Window:AddTab({Title="Filters"})
}

Tabs.Main:AddToggle("MT",{
    Title="Enable Logger",
    Default=getgenv().SeiLogger_Active
}):OnChanged(function(v)
    getgenv().SeiLogger_Active = v
    SaveConfig()
end)

Tabs.Main:AddInput("WH",{
    Title="Discord Webhook",
    Default=getgenv().WebhookURL,
    Placeholder="https://discord.com/api/webhooks/...",
    Callback=function(v)
        getgenv().WebhookURL = v -- FIXED
        SaveConfig()
    end
})

Tabs.Main:AddButton({
    Title="Test Webhook",
    Callback=function()
        SendWebhook({content="âœ… Webhook connected!"})
    end
})

for r,_ in pairs(getgenv().Toggles) do
    Tabs.Filters:AddToggle(r,{
        Title="Log "..r,
        Default=getgenv().Toggles[r]
    }):OnChanged(function(v)
        getgenv().Toggles[r] = v
        SaveConfig()
    end)
end

Window:SelectTab(1)
Fluent:Notify({Title="Zavide Logger", Content="Public Safe Loaded", Duration=4})
